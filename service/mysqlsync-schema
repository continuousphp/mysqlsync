#!/bin/bash
# description: Service for control mysqlsync schema

NAME=mysqlsync
MYSQLSYNC_BIN=/usr/local/bin/mysqlsync
PIDFILE=/var/run/$NAME.pid
DAEMON=/usr/local/bin/mysqlsync-daemon
CONF=/etc/mysqlsync/schema.conf

if [ ! -f $CONF ]
then
    echo "Configuration file missing in $CONF"
    exit 1
fi

export PATH="${PATH:+$PATH:}/usr/sbin:/sbin"

if [ ! "644" = "`stat -c '%a' $CONF`" ]
then
    echo "Config file $CONF must have permission to 644"
    exit 1
fi

source $CONF

DAEMON_OPTS="-r $RESPAWN -i -c \"DST_HOST=$DST_HOST DST_USER=$DST_USER DST_PASSWORD=$DST_PASSWORD SRC_HOST=$SRC_HOST SRC_USER=$SRC_USER SRC_PASSWORD=$SRC_PASSWORD\" schema"

case "$1" in
    start)
        echo -n "Starting daemon: "$NAME
        start-stop-daemon --start --quiet --pidfile $PIDFILE --exec $DAEMON -- $DAEMON_OPTS
        rm /etc/mysqlsync/.schema.stop
        echo "."
        ;;
    stop)
        echo -n "Stopping daemon: "$NAME
        touch /etc/mysqlsync/.schema.stop
        start-stop-daemon --stop --quiet --oknodo --pidfile $PIDFILE
        echo "."
        ;;
    status)
        echo "Status daemon: "$NAME

        if [ -f $PIDFILE ] && [ -d "/proc/`cat $PIDFILE`" ]
        then
            pid=`cat $PIDFILE`
        fi

        if [ -f /etc/mysqlsync/.schema.stop ] && [ $pid == "" ]
        then
            echo "Service is stopped"
            exit 3
        fi

        if [ ! -f /etc/mysqlsync/.schema.stop ] && [ ! $pid == "" ]
        then
            echo "Abnormal termination or never started"
            exit 4
        fi

        if [ ! -f /etc/mysqlsync/.schema.stop ] && [ $pid == "" ]

        then
            echo "Service is started with PID $pid"
            exit 0
        fi
        ;;
    restart)
        echo -n "Restarting daemon: "$NAME
        start-stop-daemon --stop --quiet --oknodo --retry 30 --pidfile $PIDFILE
        start-stop-daemon --start --quiet --pidfile $PIDFILE --exec $DAEMON -- $DAEMON_OPTS
        echo "."
        ;;
    check)
        echo -n "Checking services: "$NAME
        status
        ec=$?

        if [ "3" == "$ec" ]
        then
            echo "Service is volontary stopped, avoid auto restart"
            exit 0
        fi

        echo "Run test DB...."

        if [ "0" == "$ec" ]
        then
            exit 0
        fi

        if [ $AUTO_RESTART == "on" ]
        then
            echo "try to restart it..."
            restart
            sleep 5

            status
            if [ "0" == "$?" ]
            then
                echo "Success restart !"
                exit 0
            fi
            
            echo "Restart fail ! should send SNS or SLACK notification"
            exit 1
        fi
        ;;

  *)
      echo "Usage: "$1" {start|stop|status|restart|check}"
      exit 1
esac

exit 0
